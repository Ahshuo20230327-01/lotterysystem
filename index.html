<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lottery Pro | Secure & Optimized</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Modern Dark Theme Palette (Zinc/Indigo) */
            --bg-body: #09090b;
            --bg-card: #18181b;
            --bg-input: #27272a;
            --bg-chip: #3f3f46;
            --text-main: #f4f4f5;
            --text-muted: #a1a1aa;
            
            --accent: #6366f1; /* Indigo 500 */
            --accent-hover: #4f46e5;
            --accent-dim: rgba(99, 102, 241, 0.1);
            
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #27272a;
            
            --radius: 12px;
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.15);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* --- Toast Notification System --- */
        .toast-container {
            position: fixed; top: 24px; left: 50%; transform: translateX(-50%);
            z-index: 9999; display: flex; flex-direction: column; gap: 8px;
            pointer-events: none; width: 90%; max-width: 400px;
        }
        .toast {
            background: rgba(39, 39, 42, 0.95);
            backdrop-filter: blur(8px);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            box-shadow: var(--shadow-lg);
            display: flex; align-items: center; gap: 10px;
            opacity: 0; transform: translateY(-10px) scale(0.98);
            animation: toastIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        .toast.out { animation: toastOut 0.2s ease-in forwards; }
        
        @keyframes toastIn { to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes toastOut { to { opacity: 0; transform: translateY(-10px) scale(0.95); } }

        /* --- Custom Modal System (New) --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px); z-index: 10000;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.2s ease;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        
        .modal-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 24px; width: 90%; max-width: 400px;
            box-shadow: var(--shadow-lg); transform: scale(0.95); transition: transform 0.2s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex; flex-direction: column; gap: 16px;
        }
        .modal-overlay.active .modal-card { transform: scale(1); }

        .modal-title { font-size: 1.1rem; font-weight: 600; color: var(--text-main); }
        .modal-body { font-size: 0.95rem; color: var(--text-muted); line-height: 1.5; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 12px; margin-top: 8px; }
        
        .btn-modal {
            padding: 8px 16px; border-radius: 6px; font-size: 0.9rem; font-weight: 500; cursor: pointer; border: none; transition: 0.2s;
        }
        .btn-modal.cancel { background: transparent; color: var(--text-muted); border: 1px solid var(--border); }
        .btn-modal.cancel:hover { background: rgba(255,255,255,0.05); color: var(--text-main); }
        .btn-modal.confirm { background: var(--accent); color: white; }
        .btn-modal.confirm:hover { background: var(--accent-hover); }

        /* --- Layout --- */
        .main-container {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
            gap: 24px; width: 100%; max-width: 1200px; margin-top: 20px;
        }

        header { margin: 20px 0 30px; text-align: center; }
        h1 { 
            margin: 0; font-size: 2rem; font-weight: 800; letter-spacing: -0.025em;
            background: linear-gradient(135deg, #fff 0%, #a1a1aa 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        p.subtitle { color: var(--text-muted); font-size: 0.85rem; margin-top: 6px; letter-spacing: 0.05em; font-weight: 500; }

        .card {
            background: var(--bg-card); border-radius: var(--radius); padding: 24px;
            border: 1px solid var(--border); box-shadow: var(--shadow-lg);
            display: flex; flex-direction: column; height: 100%;
            transition: border-color 0.2s;
        }
        .card:focus-within { border-color: #3f3f46; }

        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border);
        }
        .card-title { font-size: 1.1rem; font-weight: 600; margin: 0; display: flex; align-items: center; gap: 10px; }
        .card-title svg { color: var(--text-muted); }

        /* --- Inputs --- */
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px; }
        .input-group { background: var(--bg-input); padding: 10px 12px; border-radius: 8px; border: 1px solid transparent; transition: 0.2s; }
        .input-group:focus-within { border-color: var(--accent); background: #202022; }
        .input-group label { display: block; font-size: 0.75rem; color: var(--text-muted); font-weight: 500; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.05em; }
        .input-group input { width: 100%; background: transparent; border: none; color: white; font-size: 1.5rem; font-family: 'JetBrains Mono', monospace; font-weight: 600; }

        /* --- Data Entry Area --- */
        .input-area-wrapper { position: relative; margin-bottom: 15px; }
        textarea {
            width: 100%; height: 180px; background: var(--bg-input);
            border: 1px solid transparent; border-radius: 8px;
            color: var(--text-main); padding: 16px; font-size: 0.95rem; line-height: 1.6;
            resize: vertical; font-family: 'Inter', sans-serif;
            transition: 0.2s;
        }
        textarea:focus { border-color: var(--accent); background: #202022; }
        textarea::placeholder { color: #52525b; }

        /* --- Chips Preview --- */
        .chips-container {
            display: flex; flex-wrap: wrap; gap: 6px; max-height: 0; overflow: hidden;
            transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .chips-container.active { max-height: 100px; overflow-y: auto; margin-bottom: 15px; padding-bottom: 4px; }
        .chip {
            background: var(--bg-chip); padding: 4px 8px; border-radius: 4px;
            font-size: 0.75rem; color: var(--text-main); cursor: default;
            animation: fadeIn 0.2s ease;
        }
        .chip-badge { opacity: 0.6; font-size: 0.7rem; }

        /* --- Toggle Switch Row --- */
        .status-bar-row { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-top: auto; padding-top: 10px; flex-wrap: wrap; gap: 15px;
        }
        .toggles-group { display: flex; gap: 20px; }
        
        .toggle-wrapper { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .switch { position: relative; display: inline-block; width: 32px; height: 18px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #3f3f46; transition: .3s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 14px; width: 14px; left: 2px; bottom: 2px;
            background-color: white; transition: .3s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(14px); }
        .toggle-label { font-size: 0.8rem; color: var(--text-muted); transition: color 0.2s; font-weight: 500; }
        input:checked ~ .toggle-label { color: var(--text-main); }

        /* --- Buttons --- */
        .btn-primary {
            width: 100%; margin-top: 20px; padding: 16px;
            border-radius: 12px; border: none;
            background: var(--accent); color: white;
            font-size: 1rem; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.2);
        }
        .btn-primary:hover { background: var(--accent-hover); transform: translateY(-1px); }
        .btn-primary:active { transform: translateY(0); }
        .btn-primary:disabled { background: #3f3f46; color: #71717a; cursor: not-allowed; transform: none; }

        .btn-icon {
            background: transparent; border: 1px solid var(--border); color: var(--text-muted);
            padding: 6px 10px; border-radius: 6px; font-size: 0.8rem; cursor: pointer;
            transition: 0.2s; display: flex; align-items: center; gap: 6px;
        }
        .btn-icon:hover { background: rgba(255,255,255,0.05); color: var(--text-main); border-color: #52525b; }

        /* --- Results Area --- */
        .result-container { flex: 1; display: flex; flex-direction: column; gap: 16px; position: relative; min-height: 300px; }
        
        /* Loading Overlay */
        .loading-overlay {
            position: absolute; inset: 0; background: var(--bg-card); z-index: 10;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .loading-overlay.active { opacity: 1; pointer-events: all; }
        
        .spinner {
            width: 40px; height: 40px; border: 3px solid #3f3f46;
            border-top-color: var(--accent); border-radius: 50%;
            animation: spin 0.8s linear infinite; margin-bottom: 20px;
        }
        .loading-text { font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; color: var(--accent); letter-spacing: 0.05em; }

        /* Result Groups */
        .result-group {
            background: rgba(255,255,255,0.02); border: 1px solid var(--border);
            border-radius: 8px; overflow: hidden; display: flex; flex-direction: column;
            opacity: 0; transform: translateY(10px);
        }
        .result-group.show { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        .group-header { padding: 12px 16px; font-size: 0.9rem; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        .winner .group-header { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .backup .group-header { background: rgba(245, 158, 11, 0.1); color: var(--warning); }

        .list-scroll { max-height: 250px; overflow-y: auto; padding: 8px; }
        .list-scroll::-webkit-scrollbar { width: 4px; }
        .list-scroll::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }

        .result-row {
            display: flex; padding: 8px 12px; border-radius: 4px; 
            font-size: 0.95rem; align-items: center; gap: 12px;
        }
        .result-row:hover { background: rgba(255,255,255,0.05); }
        .index { font-family: 'JetBrains Mono', monospace; color: var(--text-muted); font-size: 0.8rem; width: 24px; text-align: right; }
        .name { color: var(--text-main); font-weight: 500; }

        .empty-state {
            position: absolute; inset: 0; display: flex; flex-direction: column;
            justify-content: center; align-items: center; color: var(--text-muted); opacity: 0.5;
        }

        .action-bar { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px; 
            margin-top: auto; padding-top: 15px; border-top: 1px solid var(--border); 
        }
        .btn-action {
            padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-input);
            color: var(--text-main); cursor: pointer; font-size: 0.9rem; font-weight: 500;
            display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s;
        }
        .btn-action:hover:not(:disabled) { background: #3f3f46; border-color: #52525b; }
        .btn-action:disabled { opacity: 0.5; cursor: not-allowed; }

        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 768px) { 
            .main-container { grid-template-columns: 1fr; } 
            .card { min-height: auto; }
            .chips-container.active { max-height: 80px; }
        }
    </style>
</head>
<body>

<div class="toast-container" id="toast-container"></div>

<!-- Modal Structure -->
<div class="modal-overlay" id="modal-overlay">
    <div class="modal-card">
        <div class="modal-title" id="modal-title">ÊèêÁ§∫</div>
        <div class="modal-body" id="modal-body">ÂÖßÂÆπ</div>
        <div class="modal-actions">
            <button class="btn-modal cancel" id="modal-btn-cancel">ÂèñÊ∂à</button>
            <button class="btn-modal confirm" id="modal-btn-confirm">Á¢∫ÂÆö</button>
        </div>
    </div>
</div>

<header>
    <h1>Lottery Pro</h1>
    <p class="subtitle"></p>
</header>

<div class="main-container">
    <!-- Setting Section -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">
                <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/></svg>
                ÂêçÂñÆËàáË®≠ÂÆö
            </h2>
            <button class="btn-icon" onclick="app.requestClearInput()">
                <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                Ê∏ÖÁ©∫
            </button>
        </div>

        <div class="settings-grid">
            <div class="input-group">
                <label>Ê≠£Âèñ‰∫∫Êï∏</label>
                <input type="number" id="count-main" value="20" min="1">
            </div>
            <div class="input-group">
                <label>ÂÇôÂèñ‰∫∫Êï∏</label>
                <input type="number" id="count-backup" value="3" min="0">
            </div>
        </div>

        <div class="input-area-wrapper">
            <textarea id="input-names" placeholder="Âú®Ê≠§Ë≤º‰∏äÂêçÂñÆÔºàÊîØÊè¥ Excel Ê†ºÂºèÔºâ&#10;‰∏ÄË°å‰∏ÄÂÄãÂêçÂ≠ó..."></textarea>
            
            <!-- Visual Feedback for Names (Chips) -->
            <div id="chips-area" class="chips-container"></div>
        </div>

        <div class="status-bar-row">
            <div class="toggles-group">
                <label class="toggle-wrapper">
                    <div class="switch">
                        <input type="checkbox" id="toggle-memory">
                        <span class="slider"></span>
                    </div>
                    <span class="toggle-label">Ë®òÊÜ∂ÂêçÂñÆ</span>
                </label>
                <label class="toggle-wrapper">
                    <div class="switch">
                        <input type="checkbox" id="toggle-dedup" checked>
                        <span class="slider"></span>
                    </div>
                    <span class="toggle-label">ÂéªÈô§ÈáçË§á</span>
                </label>
            </div>
            <span id="line-count" style="font-family:'JetBrains Mono'; font-size:0.8rem; color:var(--text-muted)">0 ‰∫∫</span>
        </div>

        <button class="btn-primary" id="btn-run" onclick="app.runLottery()">
            ÈñãÂßãÊäΩÈÅ∏
        </button>
    </div>

    <!-- Result Section -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">
                <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                ÊäΩÈÅ∏ÁµêÊûú
            </h2>
            <div style="font-size:0.75rem; color:var(--success); background:rgba(16,185,129,0.1); padding:4px 8px; border-radius:4px; font-weight:500;">
                üîí CSPRNG Active
            </div>
        </div>

        <div id="result-area" class="result-container">
            <!-- Loading State -->
            <div class="loading-overlay" id="loading-overlay">
                <div class="spinner"></div>
                <div class="loading-text" id="loading-text">INITIALIZING...</div>
            </div>

            <!-- Empty State -->
            <div class="empty-state" id="empty-state">
                <div style="font-size: 3rem; margin-bottom: 10px; filter: grayscale(1);">üé≤</div>
                <p>Ê∫ñÂÇôÂ∞±Á∑í</p>
            </div>
        </div>

        <div class="action-bar">
            <button class="btn-action" id="btn-copy" onclick="app.copyResults()" disabled>
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg>
                Ë§áË£ΩÁµêÊûú
            </button>
            <button class="btn-action" id="btn-download" onclick="app.downloadResults()" disabled>
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                ‰∏ãËºâÂ†±Âëä
            </button>
        </div>
    </div>
</div>

<script>
    // ÊïàËÉΩÂÑ™ÂåñÔºöÂ∞á Regex Á∑®Ë≠ØÁßªËá≥ÂÖ®ÂüüÔºåÈÅøÂÖçÊØèÊ¨°Âü∑Ë°åÂáΩÊï∏ÊôÇÈáçË§áÁ∑®Ë≠Ø
    const INVALID_CHARS_REGEX = /[\u0000-\u0008\u000B-\u001F\u007F-\u009F\u200B-\u200D\uFEFF]/g;

    // --- Custom Modal System (Âèñ‰ª£ confirm) ---
    const Modal = {
        overlay: document.getElementById('modal-overlay'),
        title: document.getElementById('modal-title'),
        body: document.getElementById('modal-body'),
        btnConfirm: document.getElementById('modal-btn-confirm'),
        btnCancel: document.getElementById('modal-btn-cancel'),
        currentConfirmCallback: null,

        init() {
            this.btnCancel.onclick = () => this.hide();
            this.btnConfirm.onclick = () => {
                if (this.currentConfirmCallback) this.currentConfirmCallback();
                this.hide();
            };
            // ÈªûÊìäËÉåÊôØÈóúÈñâ
            this.overlay.onclick = (e) => {
                if(e.target === this.overlay) this.hide();
            };
        },

        show(title, text, onConfirm) {
            this.title.textContent = title;
            this.body.textContent = text;
            this.currentConfirmCallback = onConfirm;
            this.overlay.classList.add('active');
        },

        hide() {
            this.overlay.classList.remove('active');
            this.currentConfirmCallback = null;
        }
    };
    Modal.init();

    // --- Toast Notification System ---
    const Toast = {
        container: document.getElementById('toast-container'),
        show(message, type = 'default') {
            const el = document.createElement('div');
            el.className = 'toast';
            el.style.borderLeft = `4px solid ${type === 'error' ? 'var(--danger)' : (type === 'success' ? 'var(--success)' : 'var(--accent)')}`;
            
            // ÂÆâÂÖ®ÊÄßÔºöÈÄôË£°‰ΩøÁî® textContentÔºåÂÉÖÂúñÁ§∫‰øùÁïô innerHTML (Âõ†ÁÇ∫ÊòØÈùúÊÖãÂ≠óÂÖÉ)
            const iconSpan = document.createElement('span');
            iconSpan.textContent = type === 'success' ? '‚úÖ' : (type === 'error' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è');
            
            const msgSpan = document.createElement('span');
            msgSpan.textContent = message;

            el.appendChild(iconSpan);
            el.appendChild(msgSpan);
            this.container.appendChild(el);

            setTimeout(() => {
                el.classList.add('out');
                el.addEventListener('animationend', () => el.remove());
            }, 3000);
        }
    };

    const app = {
        els: {
            input: document.getElementById('input-names'),
            chips: document.getElementById('chips-area'),
            countMain: document.getElementById('count-main'),
            countBackup: document.getElementById('count-backup'),
            lineCount: document.getElementById('line-count'),
            resultArea: document.getElementById('result-area'),
            btnCopy: document.getElementById('btn-copy'),
            btnDownload: document.getElementById('btn-download'),
            toggleMemory: document.getElementById('toggle-memory'),
            toggleDedup: document.getElementById('toggle-dedup'),
            loader: document.getElementById('loading-overlay'),
            loadingText: document.getElementById('loading-text'),
            emptyState: document.getElementById('empty-state'),
            btnRun: document.getElementById('btn-run')
        },
        currentResultText: '',

        init() {
            // ÂàùÂßãÂåñÈö±ÁßÅËàáÈÇèËºØË®≠ÂÆö
            const isMemoryEnabled = localStorage.getItem('lottery_config_memory') === 'true';
            this.els.toggleMemory.checked = isMemoryEnabled;
            
            // Deduplication Ë®≠ÂÆöÈ†êË®≠ÁÇ∫ trueÔºåËã•ÁÑ°ÂÑ≤Â≠òÁ¥ÄÈåÑ
            const isDedupEnabled = localStorage.getItem('lottery_config_dedup') !== 'false';
            this.els.toggleDedup.checked = isDedupEnabled;

            if (isMemoryEnabled) {
                const savedNames = localStorage.getItem('lottery_names');
                if (savedNames) {
                    this.els.input.value = savedNames;
                }
            }

            this.updateData();

            // ‰∫ã‰ª∂Áõ£ËÅΩ
            this.els.input.addEventListener('input', this.debounce(() => {
                this.updateData();
                this.trySave();
            }, 200));

            // Ë®≠ÂÆöÁõ£ËÅΩ
            const handleSettingChange = (key, el, msg) => {
                el.addEventListener('change', (e) => {
                    localStorage.setItem(key, e.target.checked);
                    if (key === 'lottery_config_dedup') this.updateData(); // ÂéªÈáçÂàáÊèõÈúÄÁ´ãÂç≥Êõ¥Êñ∞ UI
                    if (msg) Toast.show(msg, e.target.checked ? "success" : "default");
                    this.trySave();
                });
            };

            handleSettingChange('lottery_config_memory', this.els.toggleMemory, "Ëá™ÂãïË®òÊÜ∂ÂäüËÉΩÂ∑≤ËÆäÊõ¥");
            handleSettingChange('lottery_config_dedup', this.els.toggleDedup, "ÂéªÈô§ÈáçË§áÂäüËÉΩÂ∑≤ËÆäÊõ¥");
        },

        trySave() {
            if (this.els.toggleMemory.checked) {
                localStorage.setItem('lottery_names', this.els.input.value);
            } else {
                localStorage.removeItem('lottery_names');
            }
        },

        debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        },

        sanitizeInput(text) {
            return text.replace(INVALID_CHARS_REGEX, '');
        },

        // Êõ¥Êñ∞‰ªãÈù¢ËàáÊï∏Êìö (‰ΩøÁî® DocumentFragment Ëàá textContent ÂÑ™ÂåñÊïàËÉΩËàáÂÆâÂÖ®)
        updateData() {
            const names = this.getNames();
            this.els.lineCount.textContent = `${names.length} ‰∫∫`;
            
            const previewLimit = 30;
            const displayNames = names.slice(0, previewLimit);
            
            if (names.length > 0) {
                this.els.chips.classList.add('active');
                
                // ÊïàËÉΩÂÑ™ÂåñÔºö‰ΩøÁî® DocumentFragment ÈÅøÂÖçÂ§öÊ¨° Reflow
                const fragment = document.createDocumentFragment();
                
                displayNames.forEach(n => {
                    const chip = document.createElement('div');
                    chip.className = 'chip';
                    chip.textContent = n; // ÂÆâÂÖ®ÊÄßÂÑ™ÂåñÔºöÈò≤Ê≠¢ XSS
                    fragment.appendChild(chip);
                });

                if (names.length > previewLimit) {
                    const moreChip = document.createElement('div');
                    moreChip.className = 'chip';
                    const badge = document.createElement('span');
                    badge.className = 'chip-badge';
                    badge.textContent = `+${names.length - previewLimit}`;
                    moreChip.appendChild(badge);
                    fragment.appendChild(moreChip);
                }
                
                // ‰∏ÄÊ¨°ÊÄßÊõ¥Êñ∞ DOM
                this.els.chips.innerHTML = ''; // Ê∏ÖÁ©∫ËàäÁöÑ
                this.els.chips.appendChild(fragment);
            } else {
                this.els.chips.classList.remove('active');
                this.els.chips.textContent = '';
            }
        },

        getNames() {
            const rawNames = this.els.input.value.split('\n')
                .map(line => this.sanitizeInput(line.trim()))
                .filter(line => line !== '');
            
            // ÈÇèËºØ‰øÆË£úÔºöÊ†πÊìöË®≠ÂÆöÂéªÈô§ÈáçË§á
            if (this.els.toggleDedup.checked) {
                return [...new Set(rawNames)];
            }
            return rawNames;
        },

        requestClearInput() {
            if(this.els.input.value === '') return;
            
            if(this.getNames().length > 5) {
                // UX ÂÑ™ÂåñÔºö‰ΩøÁî®Ëá™ÂÆöÁæ© Modal Âèñ‰ª£ confirm
                Modal.show(
                    "Ê∏ÖÁ©∫Á¢∫Ë™ç",
                    "ÊÇ®Á¢∫ÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÂêçÂñÆÂóéÔºüÊ≠§Âãï‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ",
                    () => this.performClear()
                );
            } else {
                this.performClear();
            }
        },

        performClear() {
            this.els.input.value = '';
            this.updateData();
            this.trySave();
            Toast.show("ÂêçÂñÆÂ∑≤Ê∏ÖÁ©∫");
        },

        // Ê†∏ÂøÉÂÆâÂÖ®Èö®Ê©üÈÇèËºØ
        secureShuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const randomBuffer = new Uint32Array(1);
                window.crypto.getRandomValues(randomBuffer);
                const j = Math.floor((randomBuffer[0] / (0xFFFFFFFF + 1)) * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        },

        runLottery() {
            const names = this.getNames();
            const countMain = parseInt(this.els.countMain.value) || 0;
            const countBackup = parseInt(this.els.countBackup.value) || 0;
            const totalNeed = countMain + countBackup;

            if (names.length === 0) return Toast.show("Ë´ãÂÖàËº∏ÂÖ•ÂêçÂñÆ", "error");
            if (countMain <= 0) return Toast.show("Ê≠£Âèñ‰∫∫Êï∏ÂøÖÈ†àÂ§ßÊñº 0", "error");

            const executeRun = () => {
                // UX: ÈéñÂÆöÊåâÈàï & È°ØÁ§∫ÈÅéÂ†¥ÂãïÁï´
                this.els.btnRun.disabled = true;
                this.els.loader.classList.add('active');
                
                // Ê∏ÖÁêÜËàäÁµêÊûú
                const existingGroups = this.els.resultArea.querySelectorAll('.result-group');
                existingGroups.forEach(el => el.remove());
                if(this.els.emptyState) this.els.emptyState.style.display = 'none';

                // Ê®°Êì¨ÈÅãÁÆóÈÅéÁ®ã
                let step = 0;
                const steps = ["INITIALIZING ENTROPY...", "SHUFFLING DATA...", "VERIFYING...", "GENERATING..."];
                
                const interval = setInterval(() => {
                    this.els.loadingText.textContent = steps[step % steps.length];
                    step++;
                }, 200);

                setTimeout(() => {
                    clearInterval(interval);
                    this.els.loader.classList.remove('active');
                    this.els.btnRun.disabled = false;
                    
                    const shuffled = this.secureShuffle([...names]);
                    const winners = shuffled.slice(0, countMain);
                    const backups = shuffled.slice(countMain, countMain + countBackup);
                    
                    this.renderResults(winners, backups);
                    this.prepareExportData(winners, backups, names.length);
                    Toast.show("ÊäΩÈÅ∏ÂÆåÊàê", "success");

                }, 800);
            };

            // ÈÇèËºØ‰øÆË£úËàá UXÔºöÊ™¢Êü•‰∫∫Êï∏ÊòØÂê¶Ë∂≥Â§†
            if (names.length < totalNeed) {
                Modal.show(
                    "‰∫∫Êï∏‰∏çË∂≥Ë≠¶Âëä",
                    `ÂêçÂñÆ‰∫∫Êï∏ (${names.length}) Â∞ëÊñºÁ∏ΩÈúÄÊ±Ç (${totalNeed})„ÄÇÊòØÂê¶‰ªçË¶ÅÁπºÁ∫åÂü∑Ë°åÔºü`,
                    () => executeRun()
                );
            } else {
                executeRun();
            }
        },

        renderResults(winners, backups) {
            const createGroup = (titleText, list, type, delay) => {
                const groupDiv = document.createElement('div');
                groupDiv.className = `result-group ${type}`;
                groupDiv.style.animationDelay = `${delay}s`;

                // Header
                const header = document.createElement('div');
                header.className = 'group-header';
                
                const titleSpan = document.createElement('span');
                titleSpan.textContent = titleText;
                
                const countSpan = document.createElement('span');
                countSpan.textContent = list.length;

                header.appendChild(titleSpan);
                header.appendChild(countSpan);
                groupDiv.appendChild(header);

                // List Container
                const listScroll = document.createElement('div');
                listScroll.className = 'list-scroll';

                if(list.length === 0) {
                    const emptyMsg = document.createElement('div');
                    emptyMsg.style.cssText = "padding:20px; color:var(--text-muted); text-align:center; font-size:0.9rem;";
                    emptyMsg.textContent = "(ÁÑ°‰∫∫)";
                    listScroll.appendChild(emptyMsg);
                } else {
                    const fragment = document.createDocumentFragment();
                    list.forEach((n, i) => {
                        const row = document.createElement('div');
                        row.className = 'result-row';

                        const indexSpan = document.createElement('span');
                        indexSpan.className = 'index';
                        const prefix = type === 'backup' ? 'B' : '';
                        indexSpan.textContent = `${prefix}${String(i+1).padStart(2, '0')}`;

                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'name';
                        nameSpan.textContent = n; // ÂÆâÂÖ®ÔºötextContent

                        row.appendChild(indexSpan);
                        row.appendChild(nameSpan);
                        fragment.appendChild(row);
                    });
                    listScroll.appendChild(fragment);
                }

                groupDiv.appendChild(listScroll);
                return groupDiv;
            };

            const winnerGroup = createGroup('üéâ Ê≠£ÂèñÂêçÂñÆ', winners, 'winner', 0);
            this.els.resultArea.appendChild(winnerGroup);
            setTimeout(() => winnerGroup.classList.add('show'), 10);

            if (backups.length > 0 || parseInt(this.els.countBackup.value) > 0) {
                const backupGroup = createGroup('‚ö†Ô∏è ÂÇôÂèñÂêçÂñÆ', backups, 'backup', 0.15);
                this.els.resultArea.appendChild(backupGroup);
                setTimeout(() => backupGroup.classList.add('show'), 150);
            }
        },

        prepareExportData(winners, backups, totalCount) {
            const time = new Date().toLocaleString('zh-TW');
            let text = `=== ÊäΩÈÅ∏ÁµêÊûúÂ†±Âëä ===\nÊôÇÈñì: ${time}\nÁ∏Ω‰∫∫Êï∏: ${totalCount}\n\n`;
            text += `„ÄêÊ≠£ÂèñÂêçÂñÆ„Äë(${winners.length}‰∫∫)\n`;
            winners.forEach((n, i) => text += `${i+1}. ${n}\n`);
            text += `\n„ÄêÂÇôÂèñÂêçÂñÆ„Äë(${backups.length}‰∫∫)\n`;
            backups.forEach((n, i) => text += `ÂÇô${i+1}. ${n}\n`);

            this.currentResultText = text;
            this.els.btnCopy.disabled = false;
            this.els.btnDownload.disabled = false;
        },

        copyResults() {
            if(!this.currentResultText) return;
            navigator.clipboard.writeText(this.currentResultText).then(() => {
                Toast.show("Â∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞ø", "success");
            }).catch(() => Toast.show("Ë§áË£ΩÂ§±Êïó", "error"));
        },

        downloadResults() {
            if(!this.currentResultText) return;
            const blob = new Blob([this.currentResultText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lottery_result_${new Date().getTime()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    };

    app.init();
</script>
</body>
</html>
